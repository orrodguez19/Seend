<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seend - Inicio de Sesión</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
</head>
<body class="auth-body">
    <div class="auth-container">
        <h1 class="auth-title">Seend</h1>
        <form id="authForm" class="auth-form">
            <input type="text" id="username" placeholder="Usuario (@username)" required>
            <input type="password" id="password" placeholder="Contraseña" required>
            <input type="text" id="name" placeholder="Nombre" class="hidden">
            <div class="auth-buttons">
                <button type="button" id="loginBtn" class="btn-primary">Iniciar Sesión</button>
                <button type="button" id="registerBtn" class="btn-secondary">Registrarse</button>
            </div>
        </form>
        <p id="errorMsg" class="error-message hidden"></p>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const socket = io(`ws://${window.location.host}:5000`, { transports: ['websocket'] });
            const loginBtn = document.getElementById('loginBtn');
            const registerBtn = document.getElementById('registerBtn');
            const nameInput = document.getElementById('name');
            const errorMsg = document.getElementById('errorMsg');
            let isRegisterMode = false;

            function showError(message) {
                errorMsg.textContent = message;
                errorMsg.classList.remove('hidden');
                setTimeout(() => errorMsg.classList.add('hidden'), 5000);
            }

            registerBtn.addEventListener('click', () => {
                isRegisterMode = !isRegisterMode;
                nameInput.classList.toggle('hidden', !isRegisterMode);
                loginBtn.textContent = isRegisterMode ? 'Registrarse' : 'Iniciar Sesión';
                registerBtn.textContent = isRegisterMode ? '¿Ya tienes cuenta? Iniciar Sesión' : '¿No tienes cuenta? Regístrate';
            });

            socket.on('username_status', (data) => {
                if (!data.available && isRegisterMode) showError(data.message);
            });
            socket.on('registered', handleAuthSuccess);
            socket.on('logged_in', handleAuthSuccess);
            socket.on('register_error', (data) => showError(data.message));
            socket.on('login_error', (data) => showError(data.message));

            function handleAuthSuccess(data) {
                localStorage.setItem('token', data.token);
                localStorage.setItem('user_id', data.userId);
                window.location.href = '/chat';
            }

            document.getElementById('username').addEventListener('input', () => {
                if (isRegisterMode) {
                    const username = document.getElementById('username').value.trim();
                    if (username) socket.emit('check_username', { username });
                }
            });

            const handleAuth = () => {
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();
                const name = isRegisterMode ? document.getElementById('name').value.trim() : '';

                if (!username || !password || (isRegisterMode && !name)) {
                    showError('Todos los campos son requeridos');
                    return;
                }
                if (!username.startsWith('@')) {
                    showError('El usuario debe comenzar con @');
                    return;
                }

                const authData = { username, password };
                if (isRegisterMode) {
                    authData.name = name;
                    socket.emit('register', authData);
                } else {
                    socket.emit('login', authData);
                }
            };

            loginBtn.addEventListener('click', handleAuth);
            registerBtn.addEventListener('click', (e) => {
                if (isRegisterMode) handleAuth();
            });
        });
    </script>
</body>
</html>
