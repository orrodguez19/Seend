<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Seend - Chat</title>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
      background: #eaf3fc;
      color: #333;
    }
    .header {
      display: flex;
      align-items: center;
      background: #1877f2;
      color: white;
      padding: 10px;
    }
    .menu-btn {
      background: none;
      border: none;
      cursor: pointer;
      margin-right: 10px;
    }
    .drawer {
      position: fixed;
      top: 0;
      left: -260px;
      width: 250px;
      height: 100%;
      background: #ffffff;
      border-right: 1px solid #ccc;
      overflow-y: auto;
      transition: left 0.3s ease;
      z-index: 10;
      padding: 10px;
    }
    .drawer.open {
      left: 0;
    }
    .drawer h2 {
      font-size: 18px;
      margin-bottom: 10px;
    }
    .user-item {
      display: flex;
      align-items: center;
      margin: 6px 0;
      gap: 10px;
    }
    .avatar {
      background: #1877f2;
      color: white;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
    }
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-left: auto;
    }
    .online { background: green; }
    .offline { background: gray; }

    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    .chat-box {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }
    .message {
      max-width: 70%;
      padding: 8px 12px;
      border-radius: 15px;
      margin: 5px 0;
      position: relative;
    }
    .sent {
      align-self: flex-end;
      background: #d1e7ff;
      text-align: right;
    }
    .received {
      align-self: flex-start;
      background: #ffffff;
    }
    .msg-name {
      font-size: 11px;
      font-weight: bold;
      color: #666;
    }
    .msg-time {
      font-size: 10px;
      text-align: right;
      color: #999;
    }
    .typing {
      font-style: italic;
      font-size: 12px;
      color: #fff;
      margin-left: 10px;
      animation: blink 1.2s infinite;
    }
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    .input-area {
      display: flex;
      padding: 5px;
      border-top: 1px solid #ccc;
      background: white;
    }
    .input-area input {
      flex: 1;
      padding: 8px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 20px;
      margin-right: 8px;
    }
    .input-area button {
      background: none;
      border: none;
      cursor: pointer;
    }
    .offline-banner {
      background: red;
      color: white;
      text-align: center;
      padding: 5px;
      font-size: 12px;
    }
  </style>
</head>
<body>

<div class="drawer" id="drawer">
  <h2>Usuarios</h2>
  <div id="user-list"></div>
</div>

<div class="container">
  <div class="header">
    <button class="menu-btn" onclick="toggleDrawer()">
      <svg width="24" height="24" fill="#fff"><path d="M3 6h18M3 12h18M3 18h18"/></svg>
    </button>
    <strong>Seend</strong>
    <span id="typing" class="typing" style="display: none;"></span>
  </div>

  <div id="offline" class="offline-banner" style="display: none;">Sin conexión</div>

  <div id="chat" class="chat-box"></div>

  <div class="input-area">
    <input id="message" type="text" placeholder="Escribe un mensaje..." oninput="notifyTyping()" />
    <button onclick="sendMessage()">
      <svg width="24" height="24" fill="#1877f2" viewBox="0 0 24 24">
        <path d="M2 21l21-9L2 3v7l15 2-15 2z"/>
      </svg>
    </button>
  </div>
</div>

<script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
<script>
  const socket = io();
  const username = "{{ username }}";
  const chat = document.getElementById("chat");
  const typing = document.getElementById("typing");
  const offline = document.getElementById("offline");
  const userList = document.getElementById("user-list");

  function toggleDrawer() {
    document.getElementById("drawer").classList.toggle("open");
  }

  socket.on('connect', () => {
    offline.style.display = 'none';
    socket.emit("user_connected", username);
  });

  socket.on('disconnect', () => {
    offline.style.display = 'block';
  });

  socket.on('load_messages', messages => {
    chat.innerHTML = "";
    messages.forEach(msg => addMessage(msg));
    chat.scrollTop = chat.scrollHeight;
  });

  socket.on('receive_message', msg => {
    addMessage(msg);
    chat.scrollTop = chat.scrollHeight;
  });

  function addMessage({ username: name, message, timestamp }) {
    const bubble = document.createElement("div");
    bubble.classList.add("message", name === username ? "sent" : "received");
    bubble.innerHTML = `
      <div class="msg-name">${name}</div>
      <div>${message}</div>
      <div class="msg-time">${timestamp}</div>
    `;
    chat.appendChild(bubble);
  }

  function sendMessage() {
    const input = document.getElementById("message");
    const msg = input.value.trim();
    if (msg) {
      const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      socket.emit("send_message", {
        username: username,
        message: msg,
        timestamp: time
      });
      input.value = "";
    }
  }

  let typingTimeout;
  function notifyTyping() {
    socket.emit("typing", { username });
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => {
      socket.emit("typing", { username: "" });
    }, 2000);
  }

  socket.on("user_typing", data => {
    typing.style.display = data.username ? 'inline' : 'none';
    typing.textContent = data.username ? `${data.username} está escribiendo...` : "";
  });

  socket.on("update_user_list", users => {
    userList.innerHTML = "";
    users.forEach(u => {
      const div = document.createElement("div");
      div.className = "user-item";
      div.innerHTML = `
        <div class="avatar">${u.username.charAt(0).toUpperCase()}</div>
        <div>${u.username}</div>
        <div class="status-dot ${u.online ? 'online' : 'offline'}"></div>
      `;
      userList.appendChild(div);
    });
  });
</script>

</body>
</html>