<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Seend - Mensajería</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
</head>
<body>
    <div class="app-container">
        <div id="screen-main" class="screen active">
            <header class="app-header">
                <h2 id="main-title">Chats</h2>
                <div class="header-actions">
                    <button class="icon-btn" onclick="showScreen('screen-profile')" aria-label="Perfil">
                        <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                    </button>
                    <button class="icon-btn" onclick="logout()" aria-label="Cerrar Sesión">
                        <svg viewBox="0 0 24 24"><path d="M10.09 15.59L11.5 17l5-5-5-5-1.41 1.41L10.09 13H4v2h6.09zM19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-6 16h-2v-4h2v4zm3-8h-2V7h2v4z"/></svg>
                    </button>
                </div>
            </header>
            <main class="app-content">
                <div class="chats-list" id="chats">
                    </div>
            </main>
            <nav class="app-nav">
                <button id="openNewChat" class="nav-btn active">
                    <svg viewBox="0 0 24 24"><path d="M21 6h-2v-4c0-1.1-.9-2-2-2H7c-1.1 0-2 .9-2 2v4H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-4 0V4h2v2h-2zm-8 0V4h6v2H9zM5 4h2v2H5V4zm16 14H3V8h18v10z"/></svg>
                    <span>Chats</span>
                </button>
                <button id="openNewPost" class="nav-btn">
                    <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1 1 0 0 0-1.41-1.41L15.19 7.81l3.75 3.75 1.41-1.41z"/></svg>
                    <span>Nuevo Post</span>
                </button>
                <button class="nav-btn" onclick="showScreen('screen-feed')">
                    <svg viewBox="0 0 24 24"><path d="M22 3.99c0-1.1-.9-2-2-2h-16c-1.1 0-2 .9-2 2v16.02c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V3.99zm-4 14.01h-4v-4h4v4zm0-6h-4v-4h4v4zm-6 6H6v-4h6v4zm0-6H6v-4h6v4zm8-4h-4V5h4v4zm-6 0H6V5h6v4z"/></svg>
                    <span>Feed</span>
                </button>
            </nav>
        </div>

        <div id="screen-new-chat" class="screen">
            <header class="screen-header">
                <button class="back-btn" onclick="showScreen('screen-main')">
                    <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                </button>
                <h2>Nuevo Chat</h2>
            </header>
            <main class="screen-content">
                <input type="text" id="userSearch" placeholder="Buscar usuario...">
                <div id="usersList">
                    </div>
            </main>
        </div>

        <div id="screen-new-post" class="screen">
            <header class="screen-header">
                <button class="back-btn" onclick="showScreen('screen-main')">
                    <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                </button>
                <h2>Nueva Publicación</h2>
            </header>
            <main class="screen-content post-form">
                <textarea id="postText" placeholder="¿Qué estás pensando?"></textarea>
                <div id="imagePreview"></div>
                <div class="post-actions">
                    <input type="file" id="postImage" accept="image/*" style="display: none;">
                    <button class="action-btn" onclick="document.getElementById('postImage').click()">
                        <svg viewBox="0 0 24 24"><path d="M14.4 6L14 4H5v17h19V6h-9.6zM12 17c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6zM13 11h-2v2H9v-2H7v-2h2V7h2v2h2v2z"/></svg>
                    </button>
                    <button class="btn-primary" onclick="createPost()">Publicar</button>
                </div>
            </main>
        </div>

        <div id="screen-feed" class="screen">
            <header class="screen-header">
                <button class="back-btn" onclick="showScreen('screen-main')">
                    <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                </button>
                <h2>Feed</h2>
            </header>
            <main class="screen-content" id="feed">
                </main>
        </div>

        <div id="screen-profile" class="screen">
            <header class="screen-header">
                <button class="back-btn" onclick="showScreen('screen-main')">
                    <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                </button>
                <h2>Perfil</h2>
            </header>
            <main class="screen-content profile-info">
                <div id="profileImageContainer" class="profile-image">
                    <img id="profileImg" src="" alt="Foto de perfil">
                    <button id="uploadProfileImageBtn" class="edit-btn">
                        <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1 1 0 0 0-1.41-1.41L15.19 7.81l3.75 3.75 1.41-1.41z"/></svg>
                    </button>
                    <input type="file" id="profileImageFile" accept="image/*" style="display: none;">
                </div>
                <div id="profileDetails">
                    <p><strong>Nombre:</strong> <span id="profileName"></span> <button id="editNameBtn" class="edit-btn"><svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1 1 0 0 0-1.41-1.41L15.19 7.81l3.75 3.75 1.41-1.41z"/></svg></button></p>
                    <p><strong>Usuario:</strong> <span id="profileUsername"></span></p>
                    <div id="editNameInput" style="display:none;">
                        <input type="text" id="newName" placeholder="Nuevo nombre">
                        <button onclick="saveProfileName()">Guardar</button>
                        <button onclick="setupProfileEditButtons()">Cancelar</button>
                    </div>
                </div>
                <button class="btn-danger" onclick="deleteAccount()">Eliminar Cuenta</button>
            </main>
        </div>

        <div id="screen-chat" class="screen">
            <header class="screen-header chat-header">
                <button class="back-btn" onclick="showScreen('screen-main')">
                    <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                </button>
                <div class="chat-info">
                    <h2 id="chat-title"></h2>
                    <span id="chat-header-status" class="chat-header-status offline"></span>
                </div>
            </header>
            <main class="screen-content chat-content">
                <div id="messages" class="messages-list">
                    </div>
            </main>
            <footer class="chat-footer">
                <input type="text" id="messageInput" placeholder="Escribe un mensaje...">
                <button onclick="sendMessage()">Enviar</button>
            </footer>
        </div>
    </div>

    <script>
        const socket = io(`ws://${window.location.host}:5000`, { transports: ['websocket'] });
        let currentChat = null;
        let allUsers = [];
        let isRegisterMode = false;
        let userId = localStorage.getItem('user_id');
        let token = localStorage.getItem('token');

        // Funciones compartidas
        function showError(message, container = document.body) {
            const errorElement = document.createElement('div');
            errorElement.className = 'error-message';
            errorElement.textContent = message;
            container.appendChild(errorElement);
            setTimeout(() => errorElement.remove(), 5000);
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            if (screenId === 'screen-chat') {
                const chatTitle = document.getElementById('chat-title');
                if (chatTitle && currentChat) {
                    chatTitle.textContent = currentChat.name;
                }
                loadChatMessages(currentChat ? currentChat.username : null);
            } else if (screenId === 'screen-feed') {
                loadPosts();
            }
        }

        function handleAuthSuccess(data) {
            localStorage.setItem('token', data.token);
            localStorage.setItem('user_id', data.userId);
            userId = data.userId;
            token = data.token;
            window.location.href = '/chat';
        }

        function connectSocketIO() {
            socket.on('connect', () => console.log('Connected to Socket.IO'));
            socket.on('disconnect', () => setTimeout(connectSocketIO, 5000));

            // Eventos de login.html
            socket.on('username_status', (data) => {
                if (!data.available && isRegisterMode) showError(data.message);
            });
            socket.on('registered', handleAuthSuccess);
            socket.on('logged_in', handleAuthSuccess);
            socket.on('register_error', (data) => showError(data.message));
            socket.on('login_error', (data) => showError(data.message));

            // Eventos de chat.html
            socket.on('presence_update', (data) => {
                if (window.location.pathname === '/chat') updateUserStatus(data.user_id, data.online);
            });
            socket.on('new_post', (data) => {
                if (window.location.pathname === '/chat' && document.getElementById('feed')) {
                    const feed = document.getElementById('feed');
                    const postDiv = document.createElement('div');
                    postDiv.className = 'post';
                    postDiv.innerHTML = `<strong>${data.username}:</strong> <p>${data.text}</p>${data.image ? `<img src="${data.image}" style="max-width: 100%;">` : ''}`;
                    feed.prepend(postDiv);
                }
            });
            socket.on('posts_list', (data) => {
                const feed = document.getElementById('feed');
                if (feed) {
                    feed.innerHTML = '';
                    data.posts.forEach(post => {
                        const postDiv = document.createElement('div');
                        postDiv.className = 'post';
                        postDiv.innerHTML = `<strong>${post.username}:</strong> <p>${post.text}</p>${post.image ? `<img src="${post.image}" style="max-width: 100%;">` : ''}`;
                        feed.appendChild(postDiv);
                    });
                }
            });
            socket.on('users_list', (data) => {
                const usersListDiv = document.getElementById('usersList');
                if (usersListDiv) {
                    usersListDiv.innerHTML = '';
                    allUsers = data.users;
                    allUsers.forEach(user => {
                        const userDiv = document.createElement('div');
                        userDiv.className = 'user-item';
                        userDiv.innerHTML = `<span class="username">${user.username}</span> <span class="status ${user.online ? 'online' : 'offline'}"></span>`;
                        userDiv.addEventListener('click', () => startChat(user));
                        usersListDiv.appendChild(userDiv);
                    });
                }
            });
            socket.on('chat_messages', (data) => {
                const messagesDiv = document.getElementById('messages');
                if (messagesDiv && data.username === currentChat.username) {
                    messagesDiv.innerHTML = '';
                    data.messages.forEach(msg => {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'message';
                        messageDiv.textContent = `${msg.sender}: ${msg.text}`;
                        messagesDiv.appendChild(messageDiv);
                    });
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                }
            });
            socket.on('message_received', (data) => {
                if (currentChat && data.sender === currentChat.username) {
                    const messagesDiv = document.getElementById('messages');
                    if (messagesDiv) {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'message';
                        messageDiv.textContent = `${data.sender}: ${data.text}`;
                        messagesDiv.appendChild(messageDiv);
                        messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    }
                } else if (window.location.pathname === '/chat' && data.sender !== localStorage.getItem('username')) {
                    loadChats(); // Reload chats to show new message
                }
            });
            socket.on('profile_data', (data) => {
                document.getElementById('profileName').textContent = data.name;
                document.getElementById('profileUsername').textContent = data.username;
                const profileImg = document.getElementById('profileImg');
                if (profileImg) profileImg.src = data.profile_image || '/static/images/default_avatar.png';
            });
            socket.on('profile_updated', (data) => {
                document.getElementById('profileName').textContent = data.name;
                setupProfileEditButtons(); // Hide input after saving
            });
            socket.on('profile_image_updated', (data) => {
                const profileImg = document.getElementById('profileImg');
                if (profileImg) profileImg.src = data.profile_image;
            });
            socket.on('upload_error', (data) => showError(data.message, document.getElementById('screen-profile')));
            socket.on('account_deleted', () => {
                localStorage.clear();
                window.location.href = '/login';
            });
            socket.on('delete_error', (data) => showError(data.message, document.getElementById('screen-profile')));
            socket.on('auth_error', (data) => {
                showError(data.message);
                localStorage.clear();
                window.location.href = '/login';
            });
            socket.on('error', (error) => console.error('Socket.IO Error:', error));
        }

        function loadProfile() {
            socket.emit('get_profile');
        }

        function setupProfileEditButtons() {
            const editNameBtn = document.getElementById('editNameBtn');
            const editNameInput = document.getElementById('editNameInput');
            const profileNameSpan = document.getElementById('profileName');

            if (editNameBtn && editNameInput && profileNameSpan) {
                editNameBtn.onclick = () => {
                    profileNameSpan.style.display = 'none';
                    editNameBtn.style.display = 'none';
                    editNameInput.style.display = 'block';
                    document.getElementById('newName').value = profileNameSpan.textContent;
                };
                const cancelBtn = editNameInput.querySelector('button:last-child');
                if (cancelBtn) {
                    cancelBtn.onclick = () => {
                        profileNameSpan.style.display = 'inline';
                        editNameBtn.style.display = 'inline';
                        editNameInput.style.display = 'none';
                    };
                }
            }

            const uploadBtn = document.getElementById('uploadProfileImageBtn');
            const fileInput = document.getElementById('profileImageFile');
            if (uploadBtn && fileInput) {
                uploadBtn.onclick = () => fileInput.click();
                fileInput.onchange = (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            socket.emit('upload_profile_image', { image_data: e.target.result.split(',')[1] });
                        };
                        reader.readAsDataURL(file);
                    }
                };
            }
        }

        function saveProfileName() {
            const newName = document.getElementById('newName').value.trim();
            if (newName) {
                socket.emit('update_profile', { name: newName });
            }
        }

        function deleteAccount() {
            if (confirm('¿Estás seguro de que deseas eliminar tu cuenta? Esta acción es irreversible.')) {
                socket.emit('delete_account');
            }
        }

        function loadUsers(query = '') {
            const filteredUsers = allUsers.filter(user => user.username.toLowerCase().includes(query.toLowerCase()));
            const usersListDiv = document.getElementById('usersList');
            if (usersListDiv) {
                usersListDiv.innerHTML = '';
                filteredUsers.forEach(user => {
                    const userDiv = document.createElement('div');
                    userDiv.className = 'user-item';
                    userDiv.innerHTML = `<span class="username">${user.username}</span> <span class="status ${user.online ? 'online' : 'offline'}"></span>`;
                    userDiv.addEventListener('click', () => startChat(user));
                    usersListDiv.appendChild(userDiv);
                });
            }
        }

        function startChat(user) {
            currentChat = user;
            showScreen('screen-chat');
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            if (messageInput.value.trim() && currentChat) {
                socket.emit('send_message', { recipient: currentChat.username, text: messageInput.value });
                messageInput.value = '';
            }
        }

        function loadChatMessages(username) {
            if (username) {
                socket.emit('get_chat_messages', { username: username });
            }
        }

        function loadChats() {
            // Implement logic to load the list of active chats if needed
            socket.emit('get_users'); // For simplicity, reusing get_users to show online status
        }

        function loadPosts() {
            socket.emit('get_posts');
        }

        function createPost() {
            const postText = document.getElementById('postText').value.trim();
            const imageInput = document.getElementById('postImage');
            const file = imageInput.files[0];
            let base64Image = null;

            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    base64Image = reader.result.split(',')[1];
                    socket.emit('create_post', { text: postText, image: base64Image });
                    document.getElementById('postText').value = '';
                    document.getElementById('postImage').value = '';
                    document.getElementById('imagePreview').innerHTML = '';
                    showScreen('screen-feed');
                };
                reader.readAsDataURL(file);
            } else {
                socket.emit('create_post', { text: postText, image: null });
                document.getElementById('postText').value = '';
                showScreen('screen-feed');
            }
        }

        function logout() {
            localStorage.clear();
            socket.disconnect();
            window.location.href = '/login';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            if (!token || !userId) {
                window.location.href = '/login';
                return;
            }

            connectSocketIO();
            loadProfile();
            setupProfileEditButtons();
            loadChats(); // Load initial list of chats or users for new chat

            const openNewChat = document.getElementById('openNewChat');
            if (openNewChat) {
                openNewChat.addEventListener('click', () => {
                    showScreen('screen-new-chat');
                    socket.emit('get_users');
                });
            }

            const openNewPost = document.getElementById('openNewPost');
            if (openNewPost) {
                openNewPost.addEventListener('click', () => showScreen('screen-new-post'));
            }

            const postImage = document.getElementById('postImage');
            if (postImage) {
                postImage.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const imagePreview = document.getElementById('imagePreview');
                        if (imagePreview) imagePreview.innerHTML = `<img src="${e.target.result}">`;
                    };
                    reader.readAsDataURL(file);
                });
            }

            const userSearch = document.getElementById('userSearch');
            if (userSearch) {
                userSearch.addEventListener('input', (e) => loadUsers(e.target.value.trim()));
            }

            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.addEventListener('keypress', handleKeyPress);
            }
        });
    </script>
</body>
</html>